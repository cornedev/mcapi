name: build mcapi_cli

permissions:
  contents: write

on:
  push:
    branches: main
    paths:
      - .github/workflows/*
      - '**/**/CMakeLists.txt'
      - '**/**/*.cpp'
      - '**/**/*.hpp'
  pull_request:
    branches: main
    paths:
      - .github/workflows/*
      - '**/**/CMakeLists.txt'
      - '**/**/*.cpp'
      - '**/**/*.hpp'
  
concurrency:
  group: mcapi-cli-builds
  cancel-in-progress: true

jobs:
  build-linux:
    name: build mcapi_cli (linux)
    runs-on: ubuntu-latest

    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            libarchive-dev \
            libcurl4-openssl-dev \
            nlohmann-json3-dev

      - name: configure cmake
        run: cmake -S cli -B cli/build

      - name: build project
        run: cmake --build cli/build

      - name: create package
        run: |
          tar -czf mcapi_cli-linux.tar.gz -C cli/build .

      - name: push latest linux build to builds branch
        if: github.ref == 'refs/heads/main'
        uses: actions/checkout@v4
        with:
          ref: builds
          path: builds-branch

      - name: upload linux build
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p builds-branch/builds/cli/linux
          mv mcapi_cli-linux.tar.gz builds-branch/builds/cli/linux/mcapi_cli.tar.gz
          cd builds-branch
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add builds/cli/linux/mcapi_cli.tar.gz
          git commit -m "Upload latest mcapi_cli linux build." || true
          git push origin builds

  build-macos:
    name: build mcapi_cli (macos)
    runs-on: macos-latest

    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: install dependencies
        run: brew install libarchive nlohmann-json

      - name: configure cmake
        run: |
          cmake -S cli -B cli/build \
            -DLibArchive_ROOT="$(brew --prefix libarchive)"

      - name: build project
        run: cmake --build cli/build

      - name: create package
        run: |
          tar -czf mcapi_cli-macos.tar.gz -C cli/build .

      - name: push latest macos build to builds branch
        if: github.ref == 'refs/heads/main'
        uses: actions/checkout@v4
        with:
          ref: builds
          path: builds-branch

      - name: upload macos build
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p builds-branch/builds/cli/macos
          mv mcapi_cli-macos.tar.gz builds-branch/builds/cli/macos/mcapi_cli.tar.gz
          cd builds-branch
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add builds/cli/macos/mcapi_cli.tar.gz
          git commit -m "Upload latest mcapi_cli macos build." || true
          git push origin builds

  build-windows-mingw:
    name: build mcapi_cli (windows)
    runs-on: windows-latest

    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-libarchive
            mingw-w64-x86_64-curl
            mingw-w64-x86_64-nlohmann-json
      - name: build project
        shell: msys2 {0}
        run: |
          cmake -S cli -B cli/build -G "MinGW Makefiles"
          cmake --build cli/build

      - name: create package
        shell: pwsh
        run: |
          Compress-Archive -Path cli/build/* -DestinationPath mcapi_cli-windows.zip

      - name: push latest windows build to builds branch
        if: github.ref == 'refs/heads/main'
        uses: actions/checkout@v4
        with:
          ref: builds
          path: builds-branch

      - name: upload windows build
        if: github.ref == 'refs/heads/main'
        shell: pwsh
        run: |
          Set-Location -Path builds-branch
          $target = "builds/cli/windows"
          if (-Not (Test-Path $target)) { New-Item -ItemType Directory -Force -Path $target }
          Move-Item ..\mcapi_cli-windows.zip "$target\mcapi_cli.zip" -Force
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add builds/cli/windows/mcapi_cli.zip
          git commit -m "Upload latest mcapi_cli windows build." || Write-Host "No changes"
          git push origin builds
